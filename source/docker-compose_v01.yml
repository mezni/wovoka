version: "3.9"

networks:
  secure_net:
    driver: bridge

secrets:
  keycloak_admin_user:
    file: ./secrets/keycloak_admin_user.txt
  keycloak_admin_pass:
    file: ./secrets/keycloak_admin_pass.txt
  postgres_password:
    file: ./secrets/postgres_password.txt
  tyk_secret:
    file: ./secrets/tyk_secret.txt

volumes:
  postgres_data:
  keycloak_data:

services:
  # ------------------------
  # PostgreSQL (Persistent & Internal)
  # ------------------------
  postgres:
    image: postgres:17
    container_name: keycloak_postgres
    restart: unless-stopped
    networks:
      - secure_net
    environment:
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_DB: keycloak
    secrets:
      - postgres_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports: [] # No external exposure
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "keycloak"]
      interval: 10s
      retries: 5

  # ------------------------
  # Keycloak (Auth / Identity Provider)
  # ------------------------
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: keycloak
    restart: unless-stopped
    networks:
      - secure_net
    command:
      - start
      - --https-port=8443
      - --import-realm
    environment:
      KC_DB: postgres
      KC_DB_URL_HOST: postgres
      KC_DB_URL_DATABASE: keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD_FILE: /run/secrets/postgres_password
      KC_HOSTNAME: keycloak.local
      KC_PROXY: edge
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD_FILE: /run/secrets/keycloak_admin_pass
    secrets:
      - keycloak_admin_user
      - keycloak_admin_pass
      - postgres_password
    volumes:
      - ./realms:/opt/keycloak/data/import:ro
      - keycloak_data:/opt/keycloak/data:rw
    ports:
      - "8443:8443"  # Serve via HTTPS
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-k", "https://localhost:8443/realms/master"]
      interval: 10s
      retries: 5

  # ------------------------
  # Tyk Gateway
  # ------------------------
  tyk-gateway:
    image: tykio/tyk-gateway:latest
    container_name: tyk-gateway
    restart: unless-stopped
    networks:
      - secure_net
    environment:
      TYK_GW_SECRET_FILE: /run/secrets/tyk_secret
      TYK_GW_STORAGE_TYPE: redis
      TYK_GW_NODESECRET: changeme-node-secret
    secrets:
      - tyk_secret
    volumes:
      - ./tyk.standalone.conf:/opt/tyk-gateway/tyk.conf:ro
    ports:
      - "8080:8080"  # Expose only the gateway